# Jarvis - Digital Employee Agent

> Just A Rather Very Intelligent System

## 项目定位

一个开源的、能够操作电脑完成任何任务的 GUI 自动化 Agent。目标是实现一个"数字员工"——给它一个任务，它就能像人类一样通过看屏幕、点击鼠标、敲键盘来完成。

**项目名**: Jarvis
**CLI 命令**: `jarvis`
**核心目标**: 操作速度达到人类员工的 2 倍以上
**License**: MIT

---

## 一、核心架构

### 1.1 Agent 结构（类人脑模型）

```
┌─────────────────────────────────────────────────────────────┐
│                         Agent                                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │                      Head                            │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌───────────────┐  │    │
│  │  │    Brain    │ │  Cerebellum │ │    Hippocampus │  │    │
│  │  │   (大脑)    │ │   (小脑)    │ │   (海马体)     │  │    │
│  │  │             │ │             │ │                │  │    │
│  │  │ - 思考决策  │ │ - 动作解析  │ │ - 短期记忆    │  │    │
│  │  │ - 任务规划  │ │ - 工具调用  │ │   (12h内)     │  │    │
│  │  │ - 状态分析  │ │ - 参数转换  │ │ - 长期记忆    │  │    │
│  │  └─────────────┘ └─────────────┘ │   (偏好/技能) │  │    │
│  │                                   └───────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  Tools   │ │   MCP    │ │  Skills  │ │ ID-Card  │       │
│  │ 内置工具 │ │ 工具扩展 │ │ 能力持久 │ │ A2A身份  │       │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 模块职责

| 模块 | 职责 | 说明 |
|------|------|------|
| **Brain (大脑)** | 思考与决策 | 分析屏幕截图、理解任务、制定计划、判断下一步动作 |
| **Cerebellum (小脑)** | 动作执行 | 解析 Brain 的决策，转换为具体的工具调用，处理坐标转换 |
| **Hippocampus (海马体)** | 记忆管理 | 管理短期记忆（12h内上下文）和长期记忆（偏好/技能/历史） |
| **Tools** | 内置工具集 | 文件操作、终端操作、GUI操作（鼠标/键盘）、截图等 |
| **MCP** | 工具扩展 | 通过 MCP 协议接入外部工具，扩展 Agent 能力 |
| **Skills** | 能力持久化 | 将学到的操作流程保存为可复用的技能 |
| **ID-Card** | A2A 身份 | 用于 Agent 间通信的身份标识，遵循 Google A2A 协议 |

---

## 二、多 Agent 架构

### 2.1 角色定义

| 角色 | 身份 | 能力 |
|------|------|------|
| **User** | 雇主/主管 | 发送任务、审批决策、提供反馈 |
| **Main Agent** | 主员工 | 拥有完整 GUI 控制权（屏幕/键盘/鼠标） |
| **Sub Agent** | 子员工 | 无焦点操作（终端/浏览器自动化）或在 Docker 中独立工作 |

### 2.2 控制权分配

```
┌─────────────────────────────────────────────────────────────┐
│                      Host Machine                            │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                   Main Agent                         │   │
│   │   - 屏幕截图 ✓                                       │   │
│   │   - 鼠标控制 ✓                                       │   │
│   │   - 键盘控制 ✓                                       │   │
│   │   - 焦点操作 ✓                                       │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                   Sub Agents                         │   │
│   │   - 终端操作 ✓ (无焦点)                              │   │
│   │   - 浏览器自动化 ✓ (Playwright headless)            │   │
│   │   - API 调用 ✓                                       │   │
│   │   - 文件操作 ✓                                       │   │
│   │   - GUI 操作 ✗ (需要进入 Docker)                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Docker Containers (可选)                │   │
│   │   ┌─────────────┐  ┌─────────────┐                  │   │
│   │   │ Sub Agent 1 │  │ Sub Agent 2 │  ...             │   │
│   │   │ + 虚拟显示器│  │ + 虚拟显示器│                  │   │
│   │   │ 完整GUI能力 │  │ 完整GUI能力 │                  │   │
│   │   └─────────────┘  └─────────────┘                  │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 A2A 协议

遵循 Google Agent-to-Agent 协议，用于：
- Main Agent 与 Sub Agent 之间的任务分配
- 不同机器上的 Agent 之间的协作
- User 与 Agent 之间的通信（User 作为特殊角色）

---

## 三、输入网关 (Gateway)

### 3.1 架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Gateway                               │
│                                                              │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│   │  TUI Input  │  │ WebUI Input │  │ Email Input │        │
│   │  (开发调试) │  │  (主要交互) │  │  (远程任务) │        │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│          │                │                │                │
│          └────────────────┼────────────────┘                │
│                           ▼                                  │
│                  ┌─────────────────┐                        │
│                  │ Message Router  │                        │
│                  │  - 消息标准化   │                        │
│                  │  - 优先级排序   │                        │
│                  │  - 白名单过滤   │                        │
│                  └────────┬────────┘                        │
│                           │                                  │
└───────────────────────────┼─────────────────────────────────┘
                            ▼
                    ┌─────────────┐
                    │    Agent    │
                    └─────────────┘
```

### 3.2 输入渠道详情

| 渠道 | 用途 | 功能 |
|------|------|------|
| **TUI** | 开发调试 | 显示 LLM 完整回复，快速测试 |
| **WebUI** | 主要交互 | 完整对话界面，实时显示 Agent 状态和消息 |
| **Email** | 远程任务 | 白名单过滤，支持文本/图片/视频/文件附件，邮件回复 |

### 3.3 邮件输入规则

- 维护发件人白名单
- 自动接收并过滤邮件
- 解析邮件内容（文本、图片、视频、附件）
- 回复时收件人必须在白名单内

---

## 四、记忆系统 (Hippocampus)

### 4.1 短期记忆

- **时间范围**：12 小时内
- **内容**：
  - 当前任务上下文
  - 最近的对话历史
  - 操作步骤记录
  - 屏幕状态快照
- **存储**：内存 + 本地文件缓存

### 4.2 长期记忆

- **内容**：
  - 用户偏好（"我喜欢用 Chrome 不用 Safari"）
  - 学到的技能（"怎么用 Figma 导出"）
  - 历史任务记录
  - 常用操作模式
- **存储**：向量数据库 + 结构化数据（JSON/SQLite）

### 4.3 记忆压缩策略

参考 MineContext 项目实现：

- **pHash 去重**：使用感知哈希对截图去重，汉明距离阈值 ≤ 7 视为重复
- **遗忘曲线**：`P(t) = 1 - e^(-t/τ)`，基于时间、重要性、访问频率自动淘汰
- **类型感知合并**：不同类型上下文有不同保留策略
  - 状态上下文：7 天
  - 活动上下文：90 天
  - 语义上下文：180 天
  - 实体上下文：365 天
- **定期压缩**：将相似上下文合并，减少存储占用

---

## 五、动作空间 (Action Space)

基于 UI-TARS 项目，使用 `@computer-use/nut-js` 实现。

### 5.1 鼠标动作

| 动作 | 别名 | 参数 |
|------|------|------|
| `click` | `left_click`, `left_single` | `start_box: [x1, y1, x2, y2]` |
| `double_click` | `left_double` | `start_box: [x1, y1, x2, y2]` |
| `right_click` | `right_single` | `start_box: [x1, y1, x2, y2]` |
| `middle_click` | `middle_single` | `start_box: [x1, y1, x2, y2]` |
| `mouse_move` | `move`, `hover` | `start_box: [x1, y1, x2, y2]` |
| `drag` | `left_click_drag` | `start_box`, `end_box` |
| `scroll` | - | `start_box`, `direction: up/down/left/right` |

### 5.2 键盘动作

| 动作 | 参数 |
|------|------|
| `type` | `content: string` |
| `hotkey` | `key: string` (如 "ctrl c", "cmd shift s") |
| `press` | `key: string` |
| `release` | `key: string` |

### 5.3 系统动作

| 动作 | 说明 |
|------|------|
| `screenshot` | 截取屏幕 |
| `wait` | 等待指定时间 |
| `finished` | 任务完成 |
| `call_user` | 请求用户介入 |

### 5.4 坐标系统

```typescript
interface Coordinates {
  raw?: { x: number; y: number };         // 绝对像素坐标
  normalized?: { x: number; y: number };  // 归一化坐标 (0-1)
}
```

- 支持绝对坐标和归一化坐标
- 自动处理 Retina 显示器缩放

---

## 六、LLM 抽象层

### 6.1 支持的模型

| Provider | 模型 | 用途 |
|----------|------|------|
| **Anthropic** | Claude 4.5 Opus | 主要视觉理解和决策 |
| **OpenAI Compatible** | GPT-4V 等 | 备选/自定义模型 |

### 6.2 配置

```typescript
interface LLMConfig {
  provider: 'anthropic' | 'openai';
  apiKey: string;
  baseUrl?: string;  // 允许自定义 URL
  model: string;
}
```

---

## 七、错误处理

### 7.1 策略

- **无自动恢复机制**：信任 Agent 的判断
- **Prompt 引导**：在 prompt 中要求 Agent 反思、避免跑偏
- **人工介入**：任务不明确时请求用户输入（通过消息，不是帮 Agent 操作）

### 7.2 介入触发条件

- 任务描述模糊
- 连续多次操作无进展
- Agent 主动调用 `call_user`

---

## 八、技术栈

| 类别 | 选择 |
|------|------|
| **语言** | TypeScript |
| **运行时** | Node.js (ES Modules) |
| **GUI 自动化** | @computer-use/nut-js |
| **截图** | macOS screencapture / Electron desktopCapturer |
| **浏览器自动化** | Playwright |
| **向量数据库** | TBD (本地优先) |
| **WebUI** | TBD |
| **邮件** | IMAP/SMTP |

---

## 九、平台支持

| 平台 | 优先级 | 状态 |
|------|--------|------|
| **macOS** | P0 | MVP |
| **Linux** | P1 | 后续 |
| **Windows** | P2 | 后续 |

---

## 十、MVP 功能范围

### 10.1 必须实现

- [ ] 基础对话能力（TUI）
- [ ] 屏幕截图 + VLM 分析
- [ ] 鼠标操作（click, double_click, right_click, drag, scroll）
- [ ] 键盘操作（type, hotkey）
- [ ] 完成搜索任务（打开浏览器，搜索内容）
- [ ] 完成发送消息任务（打开应用，发送消息）
- [ ] LLM 抽象层（Anthropic + OpenAI Compatible）
- [ ] 基础记忆（当前会话上下文）

### 10.2 MVP 后

- [ ] WebUI
- [ ] 邮件输入
- [ ] 长期记忆
- [ ] Sub Agent 支持
- [ ] Docker 虚拟显示器
- [ ] A2A 协议完整实现
- [ ] Skills 持久化
- [ ] MCP 工具扩展

---

## 十一、目录结构（预期）

```
jarvis/
├── src/
│   ├── agent/
│   │   ├── Agent.ts              # Agent 主类
│   │   ├── head/
│   │   │   ├── Brain.ts          # 大脑 - 思考决策
│   │   │   ├── Cerebellum.ts     # 小脑 - 动作执行
│   │   │   └── Hippocampus.ts    # 海马体 - 记忆
│   │   ├── tools/                # 内置工具
│   │   ├── mcp/                  # MCP 扩展
│   │   ├── skills/               # 技能持久化
│   │   └── id-card/              # A2A 身份
│   │
│   ├── gateway/
│   │   ├── Gateway.ts            # 网关主类
│   │   ├── tui/                  # TUI 输入
│   │   ├── webui/                # WebUI 输入
│   │   └── email/                # 邮件输入
│   │
│   ├── executor/
│   │   ├── ActionExecutor.ts     # 动作执行器
│   │   ├── mouse.ts              # 鼠标操作
│   │   ├── keyboard.ts           # 键盘操作
│   │   └── screenshot.ts         # 截图
│   │
│   ├── llm/
│   │   ├── LLMProvider.ts        # LLM 抽象接口
│   │   ├── AnthropicProvider.ts  # Anthropic 实现
│   │   └── OpenAIProvider.ts     # OpenAI Compatible 实现
│   │
│   ├── memory/
│   │   ├── ShortTermMemory.ts    # 短期记忆
│   │   └── LongTermMemory.ts     # 长期记忆
│   │
│   └── cli/
│       └── main.ts               # CLI 入口
│
├── package.json
├── tsconfig.json
└── REQUIREMENTS.md
```

---

## 十二、开放问题

1. **向量数据库选型**：本地优先，考虑 LanceDB / Chroma / SQLite-VSS
2. **WebUI 框架**：考虑 Next.js / SvelteKit / 纯静态
3. **Docker 虚拟显示器方案**：Xvfb + VNC？
4. **多焦点操作**：系统级改造，作为远期目标研究

---

## 修订历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 0.1 | 2026-02-01 | 初始需求文档 |
| 0.2 | 2026-02-01 | 确定项目名 Jarvis，添加记忆压缩策略（MineContext） |
